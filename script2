-- Brandon's MM2 Hub üî• | Role-Smart Silent Aimbot (Sheriff ‚Üí Murder Only | Murder ‚Üí Everyone!)
-- FIXED: No nil errors on Drawing, smooth attached ESP, no lag/spam

local ArrayField = loadstring(game:HttpGet('https://raw.githubusercontent.com/UI-Interface/CustomFIeld/main/RayField.lua'))()

local Window = ArrayField:CreateWindow({
   Name = "Brandon's MM2 Hub",
   LoadingTitle = "Smart Silent Aimbot Loading... (Fully Fixed)",
   LoadingSubtitle = "Sheriff locks Murderer only | Murderer hits all",
   ConfigurationSaving = {
      Enabled = true,
      FolderName = "MM2Hub",
      FileName = "BrandonConfig"
   }
})

-- Services
local Players              = game:GetService("Players")
local RunService           = game:GetService("RunService")
local UserInputService     = game:GetService("UserInputService")
local Camera               = workspace.CurrentCamera
local LocalPlayer          = Players.LocalPlayer

local OriginalRaycast      = workspace.Raycast

-- Globals
getgenv().SilentAimEnabled = false
getgenv().FOVRadius        = 250
getgenv().VisibleCheck     = false
getgenv().TargetPart       = "Head"
getgenv().HitChance        = 100
getgenv().PredictionAmount = 0.165
getgenv().FOVMode          = "Mouse"

local ESPBoxes             = {}
local MurderESP            = false
local SheriffESP           = false

-- Drawing Objects (with fallback)
local FOVCircle = Drawing.new("Circle")
if FOVCircle then
   FOVCircle.NumSides     = 100
   FOVCircle.Thickness    = 2
   FOVCircle.Radius       = getgenv().FOVRadius
   FOVCircle.Filled       = false
   FOVCircle.Transparency = 0.8
   FOVCircle.Color        = Color3.fromRGB(255, 0, 0)
   FOVCircle.Visible      = false
end

local AimBox = Drawing.new("Square")
if AimBox then
   AimBox.Size      = Vector2.new(12, 12)
   AimBox.Thickness = 3
   AimBox.Filled    = true
   AimBox.Color     = Color3.fromRGB(0, 255, 0)
   AimBox.Visible   = false
end

-- Role Cache
local RoleCache     = {}
local RoleCacheTime = {}
local ROLE_CACHE_DURATION = 1.8

local function GetRole(plr)
   if not plr then return "Innocent" end
   local now = tick()
   if RoleCache[plr] and (now - (RoleCacheTime[plr] or 0)) < ROLE_CACHE_DURATION then
      return RoleCache[plr]
   end

   local char = plr.Character
   if not char then
      RoleCache[plr] = "Innocent"
      RoleCacheTime[plr] = now
      return "Innocent"
   end

   local bp = plr:FindFirstChild("Backpack")
   local role = "Innocent"

   if (bp and bp:FindFirstChild("Knife")) or char:FindFirstChild("Knife") then
      role = "Murderer"
   elseif (bp and bp:FindFirstChild("Gun")) or char:FindFirstChild("Gun") then
      role = "Sheriff"
   end

   RoleCache[plr]     = role
   RoleCacheTime[plr] = now
   return role
end

-- Safe ESP Creation
local function CreateESP(plr)
   if plr == LocalPlayer or not plr:IsA("Player") then return end

   local success, Box = pcall(Drawing.new, "Square")
   if not success or not Box then return end

   Box.Thickness    = 2
   Box.Filled       = false
   Box.Transparency = 1
   Box.Visible      = false

   local success2, NameTag = pcall(Drawing.new, "Text")
   if not success2 or not NameTag then
      pcall(function() Box:Remove() end)
      return
   end

   NameTag.Size     = 16
   NameTag.Center   = true
   NameTag.Outline  = true
   NameTag.Font     = 2
   NameTag.Visible  = false

   ESPBoxes[plr] = {Box = Box, Name = NameTag}
end

local function RemoveESP(plr)
   local data = ESPBoxes[plr]
   if data then
      pcall(function() if data.Box then data.Box:Remove() end end)
      pcall(function() if data.Name then data.Name:Remove() end end)
      ESPBoxes[plr] = nil
   end
   RoleCache[plr]     = nil
   RoleCacheTime[plr] = nil
end

-- Throttled logic (show/hide + color/text)
local function UpdateESPLogic()
   if not (MurderESP or SheriffESP) then
      for _, data in pairs(ESPBoxes) do
         pcall(function() data.Box.Visible = false end)
         pcall(function() data.Name.Visible = false end)
      end
      return
   end

   for plr, data in pairs(ESPBoxes) do
      local char = plr.Character
      if not (char and char:FindFirstChild("HumanoidRootPart") and char:FindFirstChild("Humanoid") and char.Humanoid.Health > 0) then
         pcall(function() data.Box.Visible = false end)
         pcall(function() data.Name.Visible = false end)
         continue
      end

      local root = char.HumanoidRootPart
      local _, onScreen = Camera:WorldToViewportPoint(root.Position)
      if not onScreen then
         pcall(function() data.Box.Visible = false end)
         pcall(function() data.Name.Visible = false end)
         continue
      end

      local role = GetRole(plr)
      local shouldShow = false
      local color = Color3.fromRGB(128,128,128)

      if role == "Murderer" and MurderESP then
         shouldShow = true
         color = Color3.fromRGB(255,0,0)
      elseif role == "Sheriff" and SheriffESP then
         shouldShow = true
         color = Color3.fromRGB(0,255,0)
      end

      if shouldShow then
         pcall(function()
            data.Box.Color = color
            data.Name.Color = color
            data.Name.Text = plr.Name .. " [" .. role .. "]"
            data.Box.Visible = true
            data.Name.Visible = true
         end)
      else
         pcall(function()
            data.Box.Visible = false
            data.Name.Visible = false
         end)
      end
   end
end

-- Smooth per-frame positioning
local function UpdateESPPositions()
   for plr, data in pairs(ESPBoxes) do
      pcall(function()
         if not data.Box.Visible then return end

         local char = plr.Character
         if not (char and char:FindFirstChild("HumanoidRootPart")) then
            data.Box.Visible = false
            data.Name.Visible = false
            return
         end

         local root = char.HumanoidRootPart
         local rootPos, visible = Camera:WorldToViewportPoint(root.Position)
         if not visible then
            data.Box.Visible = false
            data.Name.Visible = false
            return
         end

         local top    = Camera:WorldToViewportPoint(root.Position + Vector3.new(0, 3, 0))
         local bottom = Camera:WorldToViewportPoint(root.Position - Vector3.new(0, 3.5, 0))
         local height = math.abs(top.Y - bottom.Y)
         local width  = height * 0.6

         data.Box.Size     = Vector2.new(width, height)
         data.Box.Position = Vector2.new(rootPos.X - width/2, rootPos.Y - height/2)

         data.Name.Position = Vector2.new(rootPos.X, rootPos.Y - height/2 - 20)
      end)
   end
end

-- Player connections
for _, plr in ipairs(Players:GetPlayers()) do task.spawn(CreateESP, plr) end
Players.PlayerAdded:Connect(function(plr) task.spawn(CreateESP, plr) end)
Players.PlayerRemoving:Connect(RemoveESP)

-- Visibility check
local function IsVisible(targetPart)
   if not getgenv().VisibleCheck then return true end
   if not targetPart then return false end
   local origin = Camera.CFrame.Position
   local dir = (targetPart.Position - origin).Unit * 6000
   local res = OriginalRaycast(workspace, origin, dir)
   return not res or res.Instance:IsDescendantOf(targetPart.Parent)
end

-- FOV position
local function GetFOVPosition()
   if getgenv().FOVMode == "Full" then return Camera.ViewportSize / 2 end
   local mouse = UserInputService:GetMouseLocation()
   if UserInputService.MouseBehavior == Enum.MouseBehavior.LockCenter then
      return Camera.ViewportSize / 2
   end
   return mouse
end

-- Target finding (cached)
local cachedTarget = nil
local lastCacheTime = 0
local CACHE_INTERVAL = 0.08

local function GetClosestTarget()
   local now = tick()
   if now - lastCacheTime < CACHE_INTERVAL then return cachedTarget end
   lastCacheTime = now

   local myRole = GetRole(LocalPlayer)
   local closest, minDist = nil, getgenv().FOVRadius
   local fovPos = GetFOVPosition()

   for _, plr in Players:GetPlayers() do
      if plr == LocalPlayer or not plr.Character then continue end
      local char = plr.Character
      local hum = char:FindFirstChild("Humanoid")
      if not hum or hum.Health <= 0 then continue end

      if myRole == "Sheriff" and GetRole(plr) ~= "Murderer" then continue end

      local part = char:FindFirstChild(getgenv().TargetPart) or char:FindFirstChild("HumanoidRootPart")
      if not part or not IsVisible(part) then continue end

      local screenPos, onScr = Camera:WorldToViewportPoint(part.Position)
      if not onScr then continue end

      local dist = (Vector2.new(screenPos.X, screenPos.Y) - fovPos).Magnitude
      if dist < minDist then
         minDist = dist
         closest = part
      end
   end

   cachedTarget = closest
   return closest
end

-- Silent Aim Hook
local mt = getrawmetatable(game)
local oldNamecall = mt.__namecall
setreadonly(mt, false)

mt.__namecall = newcclosure(function(self, ...)
   local args = {...}
   local method = getnamecallmethod()

   if getgenv().SilentAimEnabled and self == workspace and method == "Raycast" then
      if #args >= 2 and typeof(args[1]) == "Vector3" and typeof(args[2]) == "Vector3" then
         local target = GetClosestTarget()
         if target and math.random(1,100) <= getgenv().HitChance then
            local origin = args[1]
            local vel = target.AssemblyLinearVelocity or Vector3.new()
            local predPos = target.Position + vel * getgenv().PredictionAmount
            local newDir = (predPos - origin).Unit * 6000

            local newArgs = {origin, newDir}
            if args[3] and typeof(args[3]) == "RaycastParams" then
               table.insert(newArgs, args[3])
            end

            return oldNamecall(self, unpack(newArgs))
         end
      end
   end

   return oldNamecall(self, ...)
end)
setreadonly(mt, true)

-- Render loop
local ESP_LOGIC_INTERVAL = 0.14
local lastLogicUpdate = 0

RunService.RenderStepped:Connect(function()
   local now = tick()

   if now - lastLogicUpdate >= ESP_LOGIC_INTERVAL then
      UpdateESPLogic()
      lastLogicUpdate = now
   end

   UpdateESPPositions()

   if getgenv().SilentAimEnabled then
      local target = GetClosestTarget()
      local fovPos = GetFOVPosition()

      if FOVCircle then
         FOVCircle.Position = fovPos
         FOVCircle.Radius   = getgenv().FOVRadius
         FOVCircle.Visible  = true
      end

      if target and AimBox then
         local pos, onScr = Camera:WorldToViewportPoint(target.Position)
         if onScr then
            AimBox.Position = Vector2.new(pos.X - 6, pos.Y - 6)
            AimBox.Visible  = true
         else
            AimBox.Visible = false
         end
      else
         if AimBox then AimBox.Visible = false end
      end
   else
      if FOVCircle then FOVCircle.Visible = false end
      if AimBox then AimBox.Visible = false end
   end
end)

-- UI
local MainTab = Window:CreateTab("Silent Aim Hub", 7734053495)

MainTab:CreateToggle({Name = "Enable Smart Silent Aim", CurrentValue = false, Flag = "SilentAimEnabled", Callback = function(v) getgenv().SilentAimEnabled = v end})
MainTab:CreateToggle({Name = "Visible Check (No Wallbangs)", CurrentValue = false, Flag = "VisibleCheck", Callback = function(v) getgenv().VisibleCheck = v end})
MainTab:CreateSlider({Name = "FOV Size", Range = {100, 600}, Increment = 25, Suffix = "px", CurrentValue = 250, Flag = "FOVRadius", Callback = function(v) getgenv().FOVRadius = v end})
MainTab:CreateSlider({Name = "Hit Chance", Range = {50, 100}, Increment = 5, Suffix = "%", CurrentValue = 100, Flag = "HitChance", Callback = function(v) getgenv().HitChance = v end})
MainTab:CreateDropdown({Name = "FOV Mode", Options = {"Mouse", "Center (Shift Lock)", "Full Auto"}, CurrentOption = {"Mouse"}, Flag = "FOVMode", Callback = function(opt) getgenv().FOVMode = opt end})
MainTab:CreateDropdown({Name = "Target Part", Options = {"Head", "HumanoidRootPart", "UpperTorso"}, CurrentOption = {"Head"}, Flag = "TargetPart", Callback = function(opt) getgenv().TargetPart = opt end})
MainTab:CreateToggle({Name = "Murderer ESP (Red)", CurrentValue = false, Flag = "MurderESP", Callback = function(v) MurderESP = v end})
MainTab:CreateToggle({Name = "Sheriff ESP (Green)", CurrentValue = false, Flag = "SheriffESP", Callback = function(v) SheriffESP = v end})

MainTab:CreateLabel("Role-Smart: Sheriff ‚Üí Murderer only | Murderer ‚Üí everyone")
MainTab:CreateLabel("Toggle ESPs on ‚Äî red/green boxes should appear & follow players")

ArrayField:Notify({
   Title = "MM2 Hub Loaded! üî´üó°Ô∏è",
   Content = "No more crashes ‚Äî ESP should work now.\nToggle Murderer/Sheriff ESP to test.",
   Duration = 8
})

ArrayField:LoadConfiguration()
