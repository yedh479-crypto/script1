-- Brandon's MM2 Hub ðŸ”¥ | Role-Smart Aimbot (Sheriff â†’ Murder Only | Murder â†’ Everyone!)
-- Green box = valid target. Shift Lock + FOV Modes intact!

local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()

local Window = Rayfield:CreateWindow({
   Name = "Brandon's MM2 Hub",
   LoadingTitle = "Smart Aimbot + ESP Loading...",
   LoadingSubtitle = "Sheriff auto-targets Murder | Murder hits everyone by Brandon",
   ConfigurationSaving = { Enabled = true, FolderName = "MM2Hub", FileName = "BrandonConfig" },
   KeySystem = false
})

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local Camera = workspace.CurrentCamera
local LocalPlayer = Players.LocalPlayer

local OriginalRaycast = workspace.Raycast

getgenv().SilentAimEnabled = false
getgenv().FOVRadius = 250
getgenv().VisibleCheck = false
getgenv().TargetPart = "Head"
getgenv().HitChance = 100
getgenv().PredictionAmount = 0.165
getgenv().FOVMode = "Mouse"

local ESPBoxes = {}
local MurderESP = false
local SheriffESP = false

local FOVCircle = Drawing.new("Circle")
FOVCircle.NumSides = 100
FOVCircle.Thickness = 2
FOVCircle.Radius = getgenv().FOVRadius
FOVCircle.Filled = false
FOVCircle.Transparency = 0.8
FOVCircle.Color = Color3.fromRGB(255, 0, 0)
FOVCircle.Visible = false

local AimBox = Drawing.new("Square")
AimBox.Size = Vector2.new(12, 12)
AimBox.Thickness = 3
AimBox.Filled = true
AimBox.Color = Color3.fromRGB(0, 255, 0)
AimBox.Visible = false

-- Role Detection
local function GetRole(plr)
   local char = plr.Character
   local bp = plr:FindFirstChild("Backpack")
   if (bp and bp:FindFirstChild("Knife")) or (char and char:FindFirstChild("Knife")) then
      return "Murderer"
   elseif (bp and bp:FindFirstChild("Gun")) or (char and char:FindFirstChild("Gun")) then
      return "Sheriff"
   end
   return "Innocent"
end

-- ESP (same, but uses GetRole now for color too)
local function CreateESP(plr)
   if plr == LocalPlayer then return end
   local Box = Drawing.new("Square") Box.Thickness = 2 Box.Filled = false Box.Transparency = 1
   local NameTag = Drawing.new("Text") NameTag.Size = 18 NameTag.Center = true NameTag.Outline = true NameTag.Font = 2
   ESPBoxes[plr] = {Box = Box, Name = NameTag}
end

local function RemoveESP(plr)
   if ESPBoxes[plr] then
      ESPBoxes[plr].Box:Remove()
      ESPBoxes[plr].Name:Remove()
      ESPBoxes[plr] = nil
   end
end

local function UpdateESP()
   for plr, data in pairs(ESPBoxes) do
      local char = plr.Character
      if char and char:FindFirstChild("HumanoidRootPart") and char:FindFirstChild("Humanoid") and char.Humanoid.Health > 0 then
         local root = char.HumanoidRootPart
         local pos, vis = Camera:WorldToViewportPoint(root.Position)
         if vis then
            local sizeY = (Camera:WorldToViewportPoint(root.Position - Vector3.new(0,3,0)) - Camera:WorldToViewportPoint(root.Position + Vector3.new(0,5,0))).Magnitude
            data.Box.Size = Vector2.new(sizeY * 1.2, sizeY * 2.2)
            data.Box.Position = Vector2.new(pos.X - data.Box.Size.X/2, pos.Y - data.Box.Size.Y/2)
            data.Box.Visible = false
            data.Name.Visible = false

            local role = GetRole(plr)
            local show = false
            local color = Color3.fromRGB(128, 128, 128)  -- default gray

            if role == "Murderer" and MurderESP then
               show = true
               color = Color3.fromRGB(255, 0, 0)
            elseif role == "Sheriff" and SheriffESP then
               show = true
               color = Color3.fromRGB(0, 255, 0)
            end

            if show then
               data.Box.Color = color
               data.Box.Visible = true
               data.Name.Color = color
               data.Name.Text = plr.Name .. " [" .. role .. "]"
               data.Name.Position = Vector2.new(pos.X, pos.Y - data.Box.Size.Y/2 - 20)
               data.Name.Visible = true
            end
         else
            data.Box.Visible = false
            data.Name.Visible = false
         end
      end
   end
end

for _, plr in Players:GetPlayers() do CreateESP(plr) end
Players.PlayerAdded:Connect(CreateESP)
Players.PlayerRemoving:Connect(RemoveESP)

-- Visibility
local function IsVisible(targetPart)
   if not getgenv().VisibleCheck then return true end
   local origin = Camera.CFrame.Position
   local dir = (targetPart.Position - origin).Unit * 5000
   local res = OriginalRaycast(workspace, origin, dir)
   return not res or res.Instance:IsDescendantOf(targetPart.Parent)
end

-- Smart FOV Position (shift lock friendly)
local function GetFOVPosition()
   if getgenv().FOVMode == "Full" then
      return Vector2.new(Camera.ViewportSize.X / 2, Camera.ViewportSize.Y / 2)
   end
   
   local mousePos = UserInputService:GetMouseLocation()
   if UserInputService.MouseBehavior == Enum.MouseBehavior.LockCenter then
      return Vector2.new(Camera.ViewportSize.X / 2, Camera.ViewportSize.Y / 2)
   end
   
   return mousePos
end

-- Cached target + role-smart filtering
local cachedTarget = nil
local lastCacheTime = 0
local CACHE_INTERVAL = 0.03

local function GetClosestTarget()
   local now = tick()
   if now - lastCacheTime < CACHE_INTERVAL then
      return cachedTarget
   end
   lastCacheTime = now

   local myRole = GetRole(LocalPlayer)
   local closest, minDist = nil, getgenv().FOVRadius
   local fovPos = GetFOVPosition()

   for _, plr in Players:GetPlayers() do
      if plr ~= LocalPlayer and plr.Character and plr.Character:FindFirstChild("Humanoid") and plr.Character.Humanoid.Health > 0 then
         -- ROLE FILTER:
         if myRole == "Sheriff" then
            local targetRole = GetRole(plr)
            if targetRole ~= "Murderer" then continue end  -- Sheriff ONLY murders
         end
         -- Murder: targets EVERYONE (innocents + sheriff)
         -- Innocent: targets EVERYONE (but you prob won't shoot much)

         local part = plr.Character:FindFirstChild(getgenv().TargetPart) or plr.Character:FindFirstChild("HumanoidRootPart")
         if part and IsVisible(part) then
            local screenPos, onScr = Camera:WorldToViewportPoint(part.Position)
            if onScr then
               local dist = (Vector2.new(screenPos.X, screenPos.Y) - fovPos).Magnitude
               if dist < minDist then
                  minDist = dist
                  closest = part
               end
            end
         end
      end
   end
   cachedTarget = closest
   return closest
end

-- Raycast Hook (unchanged, solid)
local mt = getrawmetatable(game)
local oldNamecall = mt.__namecall
setreadonly(mt, false)

mt.__namecall = newcclosure(function(self, ...)
   local args = {...}
   local method = getnamecallmethod()

   if getgenv().SilentAimEnabled and self == workspace and method == "Raycast" then
      if #args >= 2 and typeof(args[1]) == "Vector3" and typeof(args[2]) == "Vector3" then
         local target = GetClosestTarget()
         if target and math.random(1, 100) <= getgenv().HitChance then
            local origin = args[1]
            local predPos = target.Position + target.AssemblyLinearVelocity * getgenv().PredictionAmount
            local newDir = (predPos - origin).Unit * 5000

            local newArgs = {origin, newDir}
            if args[3] and typeof(args[3]) == "Instance" and args[3].ClassName == "RaycastParams" then
               table.insert(newArgs, args[3])
            end

            return oldNamecall(self, table.unpack(newArgs))
         end
      end
   end

   return oldNamecall(self, ...)
end)

setreadonly(mt, true)

-- Render Loop
RunService.RenderStepped:Connect(function()
   UpdateESP()

   if getgenv().SilentAimEnabled then
      local target = GetClosestTarget()
      local fovPos = GetFOVPosition()
      FOVCircle.Position = fovPos
      FOVCircle.Radius = getgenv().FOVRadius
      FOVCircle.Visible = true

      if target then
         local pos, onScr = Camera:WorldToViewportPoint(target.Position)
         if onScr then
            AimBox.Position = Vector2.new(pos.X - 6, pos.Y - 6)
            AimBox.Visible = true
         else
            AimBox.Visible = false
         end
      else
         AimBox.Visible = false
      end
   else
      FOVCircle.Visible = false
      AimBox.Visible = false
   end
end)

-- UI
local VisualsTab = Window:CreateTab("Visuals")
VisualsTab:CreateToggle({Name = "Murderer ESP (Red)", CurrentValue = false, Callback = function(v) MurderESP = v end})
VisualsTab:CreateToggle({Name = "Sheriff ESP (Green)", CurrentValue = false, Callback = function(v) SheriffESP = v end})

local CombatTab = Window:CreateTab("Combat")
CombatTab:CreateToggle({Name = "Smart Silent Aim", CurrentValue = false, Callback = function(v) getgenv().SilentAimEnabled = v end})
CombatTab:CreateLabel("Your Role: Updates on equip | Sheriff â†’ Murder Only | Murder â†’ All")
CombatTab:CreateToggle({Name = "Visible Check", CurrentValue = false, Callback = function(v) getgenv().VisibleCheck = v end})
CombatTab:CreateSlider({Name = "FOV Size", Range = {100, 600}, Increment = 25, CurrentValue = 250, Callback = function(v) getgenv().FOVRadius = v end})
CombatTab:CreateSlider({Name = "Hit Chance %", Range = {50, 100}, Increment = 5, CurrentValue = 100, Callback = function(v) getgenv().HitChance = v end})
CombatTab:CreateDropdown({
   Name = "FOV Mode",
   Options = {"Mouse", "Center (Shift Lock)", "Full Auto"},
   CurrentOption = {"Mouse"},
   Callback = function(opt) getgenv().FOVMode = opt[1] end
})
CombatTab:CreateDropdown({Name = "Target Part", Options = {"Head", "HumanoidRootPart", "UpperTorso"}, CurrentOption = {"Head"}, Callback = function(opt) getgenv().TargetPart = opt[1] end})

-- Role label updater
spawn(function()
   while true do
      local myRole = GetRole(LocalPlayer)
      -- Could add dynamic label, but Rayfield labels are static; notify on change if wanted
      wait(2)
   end
end)

Rayfield:Notify({
   Title = "Smart Aimbot Loaded! ðŸ”«ðŸ—¡ï¸",
   Content = "Sheriff: Auto-locks MURDERER only ðŸŸ¥ | Murderer: Knife anyone ðŸŸ¢ | Green box = locked target!",
   Duration = 8
})
